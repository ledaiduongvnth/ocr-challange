# IDP Document Classification & Extraction API

This repository contains a containerized API built with FastAPI, Landing AI (Vision/OCR), and Google Gemini 2.5 Flash (Semantic Structuring) for Intelligent Document Processing (IDP).

The system provides two distinct endpoints to classify multi-page documents and extract structured key-value pairs and tables into strict JSON formats according to the committee's labeling guidelines.

## üìÅ Project Structure
Ensure your directory looks like this before building:

    project_root/
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îú‚îÄ‚îÄ requirements.txt
    ‚îú‚îÄ‚îÄ app.py
    ‚îî‚îÄ‚îÄ prompts/
        ‚îú‚îÄ‚îÄ system_rules.txt
        ‚îú‚îÄ‚îÄ classification_rules.txt
        ‚îú‚îÄ‚îÄ example1_image.webp
        ‚îú‚îÄ‚îÄ example1_ocr.txt
        ‚îú‚îÄ‚îÄ example1_json.json
        ‚îú‚îÄ‚îÄ example2_image.webp
        ‚îú‚îÄ‚îÄ example2_ocr.txt
        ‚îî‚îÄ‚îÄ example2_json.json

## üöÄ 1. Build and Run the Docker Container

This project uses Docker to ensure a consistent environment. You will need your API keys for Landing AI and Google Gemini.

**Step 1: Build the Docker Image**
Open your terminal in the root directory and run:
    
    docker build -t idp_api .

**Step 2: Run the Container**
Start the container and pass your API keys as environment variables. The API will be exposed on port `47924`.
    
    docker run -p 47924:8000 \
      -e LANDING_AI_API_KEY="your_landing_ai_api_key_here" \
      -e GEMINI_API_KEY="your_gemini_api_key_here" \
      idp_api

*(Note: The container exposes port 8000 internally, which is mapped to port 47924 on your host machine).*

---

## üß™ 2. How to Test and Use the API

Once the container is running, the API is accessible at `http://localhost:47924`.

### Option A: Swagger UI (Interactive Browser Testing)
The easiest way to test the API is to open your web browser and navigate to:
üëâ **http://localhost:47924/docs**

This provides a visual interface where you can upload PDFs and test the `/classification` and `/extract` endpoints with a click of a button.

### Option B: API Endpoints & cURL Examples

#### Endpoint 1: `/classification`
* **Method:** `POST`
* **Input:** Multipart form data containing a `file` (PDF, JPG, PNG, WEBP).
* **Description:** Analyzes a multi-page document and groups consecutive pages into defined document categories.

**cURL Example:**
    
    curl -X POST "http://localhost:47924/classification" \
      -H "accept: application/json" \
      -H "Content-Type: multipart/form-data" \
      -F "file=@test_document.pdf"

**Expected Output:**
    
    {
      "status": "success",
      "page_count": 5,
      "classification": [
        {
          "index": 0,
          "document_type": "GIAY_RUT_TIEN",
          "pages": [0]
        },
        {
          "index": 1,
          "document_type": "CCCD",
          "pages": [1, 2]
        }
      ]
    }

#### Endpoint 2: `/extract`
* **Method:** `POST`
* **Input:** * `file`: The cut/separated document (PDF or Image).
    * `document_type`: The string representing the document class (e.g., `GIAY_RUT_TIEN`).
* **Description:** Extracts key-value pairs, nested form grids, and tables into a strict JSON structure.

**cURL Example:**
    
    curl -X POST "http://localhost:47924/extract" \
      -H "accept: application/json" \
      -H "Content-Type: multipart/form-data" \
      -F "file=@split_document_page_0.pdf" \
      -F "document_type=GIAY_RUT_TIEN"

**Expected Output:**
    
    {
      "status": "success",
      "data": {
        "Title": "GI·∫§Y R√öT TI·ªÄN",
        "T√™n t√†i kho·∫£n": "NGUYEN VIET HUNG",
        "S·ªë t√†i kho·∫£n": "100013014668",
        "Table1": [
          {
             "M·ªánh gi√° (Denomination)": "500,000",
             "S·ªë t·ªù (Quantity)": "2,000",
             "Th√†nh ti·ªÅn (Amount)": "1,000,000,000"
          }
        ],
        "T·ªïng c·ªông (Total)": [
          {
             "Th√†nh ti·ªÅn (Amount)": "1,000,000,000"
          }
        ]
      }
    }

## üõ†Ô∏è Error Handling
The API utilizes an auto-repairing mechanism for JSON payloads generated by the LLM to prevent syntax crashes. If a critical failure occurs (e.g., invalid API keys or network drops), the API will return a standardized error response:
    
    {
      "status": "error",
      "message": "Description of the error..."
    }