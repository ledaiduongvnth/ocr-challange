{# Copyright (c) Microsoft Corporation. All rights reserved. #}

{% extends "base.html.jinja" %}
{%- block style %}
    {# Global Style #}
    {% import "macro/dimension.css.jinja" as dimension %}
        {{ dimension.a4_paper() }}
    {% import "macro/text.css.jinja" as text %}
        {{ text.set_font(font_family, font_size) }}
        {{ text.set_hyphenation(hyphenate) }}
        {{ text.set_text_align(text_align) }}
    {% import "macro/page_layout.css.jinja" as layout %}
        {{ layout.set_page_num() }}
    {# Element-Specific Style #}
    {%- include "three_columns/document.css.jinja" with context %}

    @page { margin: 5mm !important; }
    body { display: block !important; }
    .a4-page {
        border: none;
        padding: 5mm !important;
        height: auto !important;
        min-height: 297mm;
        display: flex !important;
        flex-direction: column;
        page-break-after: auto !important;
        break-after: auto !important;
    }
    .a4-page:last-child {
        page-break-after: auto !important;
        break-after: auto !important;
    }
    {% if styles.row_gap is defined %}
    .block {
        margin-bottom: {{ styles.row_gap }}px !important;
    }
    {% endif %}
    .header {
        position: static !important;
        width: auto !important;
        height: auto !important;
        padding: 0 !important;
        margin: 0 0 4mm 0 !important;
        border: none !important;
        background: none !important;
        box-shadow: none !important;
    }
    .footer {
        position: static !important;
        width: auto !important;
        height: auto !important;
        padding: 0 !important;
        margin: 4mm 0 0 0 !important;
        margin-top: auto !important;
        border: none !important;
        background: none !important;
        box-shadow: none !important;
    }
    .hcentered-line { border-bottom: none !important; }
    .main_content {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        column-count: 1 !important;
        column-gap: 0 !important;
        flex: 1 1 auto;
    }
    .text {
        font-size: 10px !important;
    }
    .block, .table_outer, .header, .footer {
        break-inside: avoid;
        page-break-inside: avoid;
    }
   
    mjx-container[jax="CHTML"][display="false"] { display: inline-block; vertical-align: baseline; }
    mjx-container[jax="CHTML"][display="true"]  { display: block; text-align: center; margin: .6em 0; }
    pre, code { white-space: pre; }
    
{% endblock style %}

{% block body %}


<div class="a4-page">

    {% set header = input_data.get('header', {}) %}
    {% if header %}
      <div class="header">
        {% if header.content %}
          {{ header.content | safe }}
        {% else %}
        {% if header.left %}
          <div class="header-left">{{ header.left }}</div>
        {% endif %}
        {% if header.mid %}
          <div class="header-mid">{{ header.mid }}</div>
        {% endif %}
        {% if header.right %}
          <div class="header-right">{{ header.right }}</div>
        {% endif %}
        {% if header.line %}
          <div class="hcentered-line"></div>
        {% endif %}
        {% endif %}
      </div>
    {% endif %}

    <div class="main_content">

        {% set ns = namespace(formula_idx=1, fig_idx=1, tab_idx=1) %}
        {% for ele in input_data.get("body", None) %}
            
            {% if ele.type == "table" %}
            
                <div class="block table_outer">
                    {% if ele.content %}
                      {{ ele.content | safe }}
                    {% else %}
                      <p class="table_caption"> {{ ele.caption }} </p>
                      <div class="table-block">
                          {{ ele.html | safe  }}
                      </div>
                      <p class="table_footnote"> {{ ele.footnote }} </p>
                    {% endif %}
                    
                </div>
                {% set ns.tab_idx = ns.tab_idx + 1 %}
            {% elif ele.type == "figure" %}
                <div class="block">
                    <img src="{{ ele.path }}">

                    <p class="figure_caption">图{{ ns.fig_idx }}：{{ ele.caption }}</p>
                </div>
                
                {% set ns.fig_idx = ns.fig_idx + 1 %}
            {% elif ele.type in ["image", "logo", "stamp", "signature", "form"] %}
                <div class="block">
                  {% if ele.content %}
                    {{ ele.content | safe }}
                  {% elif ele.path %}
                    <img src="{{ ele.path }}">
                  {% elif ele.src %}
                    <img src="{{ ele.src }}">
                  {% endif %}
                </div>

            {% elif ele.type == "title" %}
                <div class="block">
                    {% if ele.content %}
                      {{ ele.content | safe }}
                    {% endif %}
                </div>

            {% elif ele.type in ["Body", "text"] %}
                <div class="block">
                    {% if ele.content %}
                      {{ ele.content | safe }}
                    {% else %}
                      {% for txt in ele.text %}
                          <p class="text">{{ txt }}</p>
                      {% endfor %}
                    {% endif %}
                </div>

            {% elif ele.type == "formula" %}
            
            <div class="formula-block">

                <p class="formula" data-latex="{{ ele.latex }}">{{ ele.latex }}</p>
                <p class="formula_caption">({{ ns.formula_idx }})</p>
                
            </div>
                    
            {% set ns.formula_idx = ns.formula_idx + 1 %}

            {% endif %}
            
        {% endfor %}
   
        </div>


         {% set page_footnote = input_data.get('page_footnote', None) %}
         
         <div class="page_bottom">
 
         {% if page_footnote %}
          <div class="page_footnote">
            <p class="page_footnote_p"> {{page_footnote}} </p>
          </div>
        {% endif %}
 
        {% set footer = input_data.get('footer', {}) %}
        {% if footer %}
          <div class="footer">
            {% if footer.content %}
              {{ footer.content | safe }}
            {% else %}
            {% if footer.left %}
              <div class="footer-left">{{ footer.left }}</div>
            {% endif %}
            {% if footer.mid %}
              <div class="footer-mid">{{ footer.mid }}</div>
            {% endif %}
            {% if footer.right %}
              <div class="footer-right">{{ footer.right }}</div>
            {% endif %}
            {% endif %}
          </div>
        {% endif %}

        </div>

<script>
(function () {
  'use strict';

  function setCellStyle(cell, cssObj) {
  
    const st = cell.style;
    for (const k in cssObj) st[k] = cssObj[k];
  }

  function pickHeaderRow(tbl) {
    const thead = tbl.querySelector('thead');
    if (thead) {
      const rows = thead.querySelectorAll('tr');
      if (rows.length) return rows[rows.length - 1];
    }
    const tbody = tbl.querySelector('tbody');
    if (tbody) {
      const row = tbody.querySelector('tr');
      if (row) return row;
    }
    return tbl.querySelector('tr');
  }

  function styleOneTable(tbl) {
    if (tbl.dataset.styled === '1') return; 
    const borderModes = [
      { mode: 'full', weight: 0.30 },
      { mode: 'row', weight: 0.20 },
      { mode: 'col', weight: 0.20 },
      { mode: 'none', weight: 0.30 }
    ];
    let r = Math.random();
    let borderMode = 'full';
    for (const opt of borderModes) {
      r -= opt.weight;
      if (r <= 0) { borderMode = opt.mode; break; }
    }
    const borderWeight = ['0.5px', '1px', '2px'][Math.floor(Math.random() * 3)];
    const borderColor = ['#000000', '#444444', '#1f5ea8'][Math.floor(Math.random() * 3)];
    const headerStyle = ['off', 'bold', 'uppercase', 'shaded'][Math.floor(Math.random() * 4)];
    const stripe = Math.random() < 0.5;
    const padding = ['4px 6px', '6px 8px', '10px 12px'][Math.floor(Math.random() * 3)];
    const radius = Math.random() < 0.5 ? '0px' : '6px';
    const bg = Math.random() < 0.5 ? '#ffffff' : '#f7f2e8';
    const align = Math.random() < 0.5 ? 'left' : 'center';

    tbl.style.borderCollapse = 'collapse';
    tbl.style.background = bg;
    tbl.style.borderRadius = radius;
    tbl.style.overflow = radius === '0px' ? 'visible' : 'hidden';

    const cells = tbl.querySelectorAll('th, td');
    cells.forEach(cell => {
      setCellStyle(cell, {
        textAlign: align,
        verticalAlign: 'middle',
        padding: padding,
        border: 'none'
      });
    });

    if (borderMode === 'full') {
      tbl.style.border = `${borderWeight} solid ${borderColor}`;
      cells.forEach(cell => { cell.style.border = `${borderWeight} solid ${borderColor}`; });
    } else if (borderMode === 'row') {
      tbl.style.border = 'none';
      const rows = tbl.querySelectorAll('tr');
      rows.forEach(row => {
        row.querySelectorAll('th, td').forEach(cell => {
          cell.style.borderBottom = `${borderWeight} solid ${borderColor}`;
        });
      });
    } else if (borderMode === 'col') {
      tbl.style.border = 'none';
      const rows = tbl.querySelectorAll('tr');
      rows.forEach(row => {
        const rowCells = row.querySelectorAll('th, td');
        rowCells.forEach((cell, idx) => {
          if (idx < rowCells.length - 1) {
            cell.style.borderRight = `${borderWeight} solid ${borderColor}`;
          }
        });
      });
    } else {
      tbl.style.border = 'none';
    }

    if (stripe) {
      const rows = tbl.querySelectorAll('tr');
      rows.forEach((row, i) => {
        if (i % 2 === 1) row.style.background = '#f1f1f1';
      });
    }

    if (headerStyle !== 'off') {
      const headerRow = pickHeaderRow(tbl);
      if (headerRow) {
        headerRow.querySelectorAll('th, td').forEach(cell => {
          if (headerStyle === 'bold') cell.style.fontWeight = '700';
          if (headerStyle === 'uppercase') cell.style.textTransform = 'uppercase';
          if (headerStyle === 'shaded') cell.style.background = '#e6e6e6';
        });
      }
    }
    tbl.dataset.styled = '1';
  }

  function styleTables(root) {
    const scope = root || document;
    scope.querySelectorAll('table:not([data-styled])').forEach(styleOneTable);
  }

  function run() {
    styleTables(document);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once: true });
  } else {
    run();
  }

  const obs = new MutationObserver(mutations => {
    for (const m of mutations) {
      for (const node of m.addedNodes) {
        if (node.nodeType !== 1) continue; 
        if (node.tagName && node.tagName.toLowerCase() === 'table') {
          styleOneTable(node);
        } else {
          styleTables(node);
        }
      }
    }
  });
  obs.observe(document.documentElement, { childList: true, subtree: true });

  window.styleTables = styleTables;
})();
</script>


  <script>
  window.MathJax = {
    startup: { typeset: true },

    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],

      processEscapes: true, 
      tags: 'none'      
    },

    options: {
      skipHtmlTags: ['script','noscript','style','textarea','pre','code']
    }
  };
  </script>
<script src="/home/ma-user/work/data_mllm/software/MathJax/es5/tex-mml-chtml.js">
</script>

{% endblock body %}
